name: Create Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate Changelog
              id: changelog
              run: |
                  # Get the current tag
                  CURRENT_TAG=${GITHUB_REF#refs/tags/}

                  # Get the previous tag
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")

                  # If there's a previous tag, generate changelog from it to current tag
                  # Otherwise, get all commits up to current tag
                  if [ -n "$PREVIOUS_TAG" ]; then
                    CHANGELOG="Changes since ${PREVIOUS_TAG}:$(git log --pretty=format:'%n- %s (%h)' ${PREVIOUS_TAG}..${CURRENT_TAG})"
                  else
                    CHANGELOG="Initial release. Changes:$(git log --pretty=format:'%n- %s (%h)' ${CURRENT_TAG})"
                  fi

                  # Escape multiline string for GitHub Actions
                  CHANGELOG="${CHANGELOG//'%'/'%25'}"
                  CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
                  CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"

                  echo "changelog=${CHANGELOG}" >> $GITHUB_OUTPUT

            - name: Create Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref }}
                  release_name: Release ${{ github.ref_name }}
                  body: ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
