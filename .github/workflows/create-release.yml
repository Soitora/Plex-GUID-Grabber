name: Create Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate Changelog
              id: changelog
              run: |
                  # Get the current tag
                  CURRENT_TAG=${GITHUB_REF#refs/tags/}

                  # Get the previous tag
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")

                  # If there's a previous tag, generate changelog from it to current tag
                  # Otherwise, get all commits up to current tag
                  if [ -n "$PREVIOUS_TAG" ]; then
                    echo "CHANGELOG<<EOF" >> $GITHUB_ENV
                    echo "Changes since ${PREVIOUS_TAG}:" >> $GITHUB_ENV
                    git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..${CURRENT_TAG} >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  else
                    echo "CHANGELOG<<EOF" >> $GITHUB_ENV
                    echo "Initial release. Changes:" >> $GITHUB_ENV
                    git log --pretty=format:"- %s (%h)" ${CURRENT_TAG} >> $GITHUB_ENV
                    echo "EOF" >> $GITHUB_ENV
                  fi

            - name: Create Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              uses: actions/create-release@v1
              with:
                  tag_name: ${{ github.ref }}
                  release_name: Release ${{ github.ref_name }}
                  body: ${{ env.CHANGELOG }}
                  draft: false
                  prerelease: false
